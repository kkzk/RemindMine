<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RemindMine AI Agent - ダッシュボード</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Markdown rendering libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js" defer></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1><i class="fas fa-robot"></i> RemindMine AI Agent</h1>
            <nav class="nav">
                <button class="nav-btn active" data-tab="dashboard">
                    <i class="fas fa-tachometer-alt"></i> ダッシュボード
                </button>
                <button class="nav-btn" data-tab="settings">
                    <i class="fas fa-cog"></i> 設定
                </button>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- ダッシュボードタブ -->
            <div id="dashboard" class="tab-content active">
                <div class="section">
                    <div class="section-header">
                        <h2><i class="fas fa-exclamation-triangle"></i> Issues & AIアドバイス</h2>
                        <button id="refresh-issues" class="btn btn-secondary">
                            <i class="fas fa-sync-alt"></i> 更新
                        </button>
                    </div>
                    
                    <div class="filters">
                        <select id="project-filter" class="filter-select">
                            <option value="">全プロジェクト</option>
                        </select>
                        <select id="status-filter" class="filter-select">
                            <option value="">全ステータス</option>
                        </select>
                        <select id="priority-filter" class="filter-select">
                            <option value="">全優先度</option>
                        </select>
                    </div>

                    <div id="loading" class="loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> 読み込み中...
                    </div>

                    <div id="issues-container" class="issues-container">
                        <!-- Issues will be loaded here -->
                    </div>

                    <div class="pagination">
                        <button id="prev-page" class="btn btn-secondary" disabled>
                            <i class="fas fa-chevron-left"></i> 前へ
                        </button>
                        <span id="page-info" class="page-info">1 / 1</span>
                        <button id="next-page" class="btn btn-secondary" disabled>
                            次へ <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Issue作成機能は廃止されました -->

            <!-- 設定タブ -->
            <div id="settings" class="tab-content">
                <div class="section">
                    <h2><i class="fas fa-cog"></i> システム設定</h2>
                    
                    <div class="settings-group">
                        <h3><i class="fas fa-robot"></i> AI自動アドバイス</h3>
                        <div class="setting-item">
                            <label class="toggle-label">
                                <input type="checkbox" id="auto-advice-toggle">
                                <span class="toggle-slider"></span>
                                自動アドバイス機能を有効にする
                            </label>
                            <p class="setting-description">
                                新しいIssueが作成された際に、AIが自動的にアドバイスを生成してコメントを投稿します。
                            </p>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3><i class="fas fa-brain"></i> AIプロバイダ設定</h3>
                        <div class="setting-item">
                            <label for="ai-provider-select">AIプロバイダ</label>
                            <select id="ai-provider-select" class="form-select">
                                <option value="ollama">Ollama (ローカル)</option>
                                <option value="openai">OpenAI</option>
                            </select>
                            <p class="setting-description">
                                使用するAIプロバイダを選択します。
                            </p>
                        </div>

                        <!-- Ollama設定 -->
                        <div id="ollama-settings" class="provider-settings">
                            <h4><i class="fas fa-microchip"></i> Ollama設定</h4>
                            <div class="setting-item">
                                <label for="ollama-model-select">LLMモデル</label>
                                <select id="ollama-model-select" class="form-select">
                                    <option value="llama3.2:1b">llama3.2:1b (軽量)</option>
                                    <option value="llama3.2:3b">llama3.2:3b (バランス)</option>
                                    <option value="llama3.2">llama3.2 (標準)</option>
                                    <option value="llama3.1">llama3.1</option>
                                    <option value="codellama">codellama</option>
                                    <option value="mistral">mistral</option>
                                    <option value="qwen2.5">qwen2.5</option>
                                    <option value="phi3">phi3</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label for="ollama-embedding-model-select">Embeddingモデル</label>
                                <select id="ollama-embedding-model-select" class="form-select">
                                    <option value="llama3.2">llama3.2</option>
                                    <option value="mxbai-embed-large">mxbai-embed-large</option>
                                    <option value="nomic-embed-text">nomic-embed-text</option>
                                    <option value="all-minilm">all-minilm</option>
                                </select>
                            </div>
                        </div>

                        <!-- OpenAI設定 -->
                        <div id="openai-settings" class="provider-settings" style="display: none;">
                            <h4><i class="fas fa-cloud"></i> OpenAI設定</h4>
                            <div class="setting-item">
                                <div id="openai-key-status" class="api-key-status">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    APIキーが設定されていません。環境変数OPENAI_API_KEYを設定してください。
                                </div>
                            </div>
                            <div class="setting-item">
                                <label for="openai-model-select">LLMモデル</label>
                                <select id="openai-model-select" class="form-select">
                                    <option value="gpt-4o">gpt-4o</option>
                                    <option value="gpt-4o-mini">gpt-4o-mini</option>
                                    <option value="gpt-4-turbo">gpt-4-turbo</option>
                                    <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                                </select>
                            </div>
                            <div class="setting-item">
                                <label for="openai-embedding-model-select">Embeddingモデル</label>
                                <select id="openai-embedding-model-select" class="form-select">
                                    <option value="text-embedding-3-small">text-embedding-3-small</option>
                                    <option value="text-embedding-3-large">text-embedding-3-large</option>
                                    <option value="text-embedding-ada-002">text-embedding-ada-002</option>
                                </select>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="provider-actions">
                                <button id="test-ai-provider" class="btn btn-secondary">
                                    <i class="fas fa-vial"></i> AIプロバイダテスト
                                </button>
                                <button id="save-ai-provider" class="btn btn-primary">
                                    <i class="fas fa-save"></i> プロバイダ設定保存
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3><i class="fas fa-memory"></i> キャッシュ管理</h3>
                        <div class="setting-item">
                            <p class="setting-description">
                                Issueの要約キャッシュを管理します。キャッシュによりAI問い合わせのコストを削減できます。
                            </p>
                            <div class="cache-info">
                                <div class="info-item">
                                    <span class="info-label">キャッシュ済みIssue数:</span>
                                    <span class="info-value" id="cache-count">Loading...</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">キャッシュファイル:</span>
                                    <span class="info-value" id="cache-file-path">Loading...</span>
                                </div>
                            </div>
                            <div class="cache-actions">
                                <button id="refresh-cache-stats" class="btn btn-secondary">
                                    <i class="fas fa-sync-alt"></i> 統計更新
                                </button>
                                <button id="clear-cache" class="btn btn-warning">
                                    <i class="fas fa-trash"></i> キャッシュクリア
                                </button>
                                <button id="reindex-rag" class="btn btn-danger">
                                    <i class="fas fa-database"></i> RAG再インデックス
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3><i class="fas fa-display"></i> 表示設定</h3>
                        <div class="setting-item">
                            <label for="issues-per-page-setting">1ページあたりのIssue数</label>
                            <input type="number" id="issues-per-page-setting" 
                                   value="20" min="5" max="100">
                        </div>
                    </div>

                    <div class="settings-group">
                        <h3><i class="fas fa-server"></i> システム情報</h3>
                        <div class="system-info">
                            <div class="info-item">
                                <span class="info-label">Redmine URL:</span>
                                <span class="info-value" id="redmine-url">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Ollama URL:</span>
                                <span class="info-value" id="ollama-url">Loading...</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ChromaDB Path:</span>
                                <span class="info-value" id="chromadb-path">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button id="save-settings" class="btn btn-primary">
                            <i class="fas fa-save"></i> 設定保存
                        </button>
                        <button id="test-connection" class="btn btn-secondary">
                            <i class="fas fa-plug"></i> 接続テスト
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- モーダル -->
    <div id="advice-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-robot"></i> AIアドバイス</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div id="advice-content"></div>
            </div>
        </div>
    </div>

    <!-- 通知 -->
    <div id="notification" class="notification">
        <div class="notification-content">
            <span id="notification-message"></span>
            <button id="notification-close" class="notification-close">&times;</button>
        </div>
    </div>

    <script src="/static/js/app.js"></script>
</body>
</html>
